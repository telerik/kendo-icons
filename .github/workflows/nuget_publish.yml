name: Publish to nuget

defaults:
  run:
    shell: bash

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - "Publish to npm"
    types:
      - completed

jobs:

  nuget-publish:
    runs-on: ubuntu-latest

    env:
      FONT_ICONS: "packages/font-icons/src-cs/Telerik.FontIcons"
      SVG_ICONS: "packages/svg-icons/src-cs/Telerik.SvgIcons"
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN_PUBLISH }}

    steps:

      - name: Checkout branch
        uses: actions/checkout@v3
        with:
          ref: develop

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          cache: 'npm'
          node-version: 14.x

      - name: Install
        run: |
          npm ci
          npm run bootstrap

      - name: Build assets
        run: |
          npm run build

      - name: Setup dotnet
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 5.0.x
          source-url: https://nuget.pkg.github.com/telerik/index.json
        env:
          NUGET_AUTH_TOKEN: '%GITHUB_TOKEN%'


      - name: Build projects
        run: |
          dotnet build -c Release ${{ env.FONT_ICONS }}/Telerik.FontIcons.csproj
          dotnet build -c Release ${{ env.SVG_ICONS }}/Telerik.SvgIcons.csproj

      - name: Pack font icons nuget
        run: |
          VERSION=$(jq '.version' packages/font-icons/package.json)
          dotnet pack -c Release ${{ env.FONT_ICONS }}/Telerik.FontIcons.csproj -p:PackageVersion=$VERSION

      - name: Pack svg icons nuget
        run: |
          VERSION=$(jq '.version' packages/svg-icons/package.json)
          dotnet pack -c Release ${{ env.SVG_ICONS }}/Telerik.SvgIcons.csproj -p:PackageVersion=$VERSION

      - name: Push nuget packages
        run: |
          dotnet nuget push ${{ env.FONT_ICONS }}/bin/Release/*.nupkg --skip-duplicate
          dotnet nuget push ${{ env.SVG_ICONS }}/bin/Release/*.nupkg --skip-duplicate
